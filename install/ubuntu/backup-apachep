#!/bin/bash
set -e

# Check if the script is run as root.
if [ "$(id -u)" -ne 0 ]; then
  echo "You must be root or use sudo."
  exit 1
fi

echo "Starting backup process for apachep container..."

# Stop the apachep container
echo "Stopping apachep container..."
lxc-stop -n apachep

# Wait for the container to fully stop
echo "Waiting for container to stop..."
while [ "$(lxc-info -n apachep -s | awk '{print $2}')" != "STOPPED" ]; do
    sleep 1
done

echo "Container apachep is stopped."

# Create backup directory if it doesn't exist
mkdir -p /var/backups

# Create backup with current date
BACKUP_FILE="/var/backups/lxc-apachep-backup-$(date +%F).tar.gz"
echo "Creating backup: $BACKUP_FILE"
tar -czvf "$BACKUP_FILE" -C /var/lib/lxc apachep

echo "Backup created successfully: $BACKUP_FILE"

# Start the container again
echo "Starting apachep container..."
lxc-start -n apachep

echo "Backup and restart process completed successfully."